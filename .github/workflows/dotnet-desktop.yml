name: PR Autom√°tica com GitHub CLI üíú

on:
  push:
    branches:
      - "feature/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  criar-pr:
    runs-on: ubuntu-latest
    steps:
      - name: üîÑ Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üß™ Verifica se gh CLI est√° dispon√≠vel
        run: |
          if ! command -v gh &> /dev/null; then
            echo "üîß Instalando GitHub CLI..."
            sudo apt update && sudo apt install gh -y
          else
            echo "‚úÖ GitHub CLI j√° est√° dispon√≠vel."
          fi

      - name: ‚ú® Cria Pull Request automaticamente (se ainda n√£o existir)
        run: |
          echo "üîç Ref recebido: ${{ github.ref }}"
          HEAD_BRANCH=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///')
          echo "üåø Branch de origem: $HEAD_BRANCH"

          EXISTING_PR=$(gh pr list --head "$HEAD_BRANCH" --base main --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "‚ÑπÔ∏è J√° existe uma PR (#$EXISTING_PR) da branch '$HEAD_BRANCH' para 'main'. Nada a fazer."
          else
            echo "üì¨ Criando nova Pull Request..."
            gh pr create \
              --title "‚ú® PR autom√°tica: $HEAD_BRANCH" \
              --body "Essa Pull Request foi gerada automaticamente ap√≥s push na branch \`$HEAD_BRANCH\`." \
              --base main \
              --head "$HEAD_BRANCH"
            echo "‚úÖ Pull Request criada com sucesso!"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
